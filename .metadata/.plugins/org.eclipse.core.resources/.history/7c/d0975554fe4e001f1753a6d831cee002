package com.kisahtegar.gudangkisah;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.Menu;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;
import android.text.TextUtils;

import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;

import com.example.warung2.AddDataActivity;
import com.example.warung2.R;

public class AddDataActivity extends Activity {
	
	private EditText id_barang, nama, jenis, stock;
	private Button submitButton;
	
	@Override
    protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_update_data);
        
        id_barang = (EditText) findViewById(R.id.id_barang);
        nama = (EditText) findViewById(R.id.nama);
        jenis = (EditText) findViewById(R.id.jenis);
        stock = (EditText) findViewById(R.id.stock);
        submitButton = (Button) findViewById(R.id.submit_button);
        
        submitButton.setOnClickListener(new View.OnClickListener() {
			
			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				String id_barangStr = id_barang.getText().toString();
	            String namaStr = nama.getText().toString();
	            String jenisStr = jenis.getText().toString();
	            String stockStr = stock.getText().toString();

	            if (TextUtils.isEmpty(id_barangStr) || TextUtils.isEmpty(namaStr) || 
	            	TextUtils.isEmpty(jenisStr) || TextUtils.isEmpty(stockStr)) {
	                 Toast.makeText(AddDataActivity.this, "Semua field harus diisi", Toast.LENGTH_SHORT).show();
	            } else {
	            	// Mengirim data ke server
	                sendDataToServer(id_barangStr, namaStr, jenisStr, stockStr);
	            }
			}
		});
	}
	
	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		// Inflate the menu; this adds items to the action bar if it is present.
		getMenuInflater().inflate(R.menu.main, menu);
		return true;
	}
	
	
	private void sendDataToServer(
		final String id_barang, 
		final String nama, 
		final String jenis,
		final String stock
	) {
		new Thread(new Runnable() {

			@Override
			public void run() {
				try {
					URL url = new URL("http://192.168.0.15:8081/gudangkisah/insertdata.php");
	                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
	                conn.setRequestMethod("POST");
	                conn.setDoOutput(true);
	                // Construct data to send
	                String postData = "id_barangg=" + id_barang +
	                                  "&nama=" + nama +
	                                  "&jenis=" + jenis +
	                                  "&stock=" + stock;

	                OutputStream os = conn.getOutputStream();
	                os.write(postData.getBytes());
	                os.flush();
	                os.close();
	                
	                int responseCode = conn.getResponseCode();
	                
	                if (responseCode == HttpURLConnection.HTTP_OK){
	                	runOnUiThread(new Runnable() {
							@Override
							public void run() {
								Toast.makeText(AddDataActivity.this, "Data berhasil disimpan", Toast.LENGTH_SHORT).show();
								Intent intent = new Intent(AddDataActivity.this, MainActivity.class);
	                            intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK);
	                            startActivity(intent);
	                            finish();
							}
						});
	                } else {
	                	runOnUiThread(new Runnable() {
							@Override
							public void run() {
								Toast.makeText(AddDataActivity.this, "Gagal mengirim data", Toast.LENGTH_SHORT).show();
							}
						});
	                }
	                
				} catch (Exception e) {
					e.printStackTrace();
					runOnUiThread(new Runnable() {
						@Override
						public void run() {
							Toast.makeText(AddDataActivity.this, "Terjadi kesalahan", Toast.LENGTH_SHORT).show();
						}
					});
				}
			}
		}).start();
	}
}
